{% extends 'base.html.twig' %}

{% block title %}Prise des équipements{% endblock %}

{% block stylesheets %}
<style>
body {
    min-height: 100vh;
    margin: 0;
    background: #fff;
    font-family: 'Segoe UI', Arial, sans-serif;
}
.success-message {
    background: #d1fae5;
    color: #065f46;
    padding: 12px 20px;
    border-radius: 6px;
    margin-bottom: 16px;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(56,161,105,0.08);
    border: 1px solid #38a169;
    transition: opacity 0.7s;
}
.error-message {
    background: #fee2e2;
    color: #991b1b;
    padding: 12px 20px;
    border-radius: 6px;
    margin-bottom: 16px;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(229,62,62,0.08);
    border: 1px solid #e53e3e;
    transition: opacity 0.7s;
}
</style>
{% endblock %}

{% block body %}

<div class="min-h-full">
  <header class="bg-white shadow-sm">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
      <h1 class="text-3xl font-bold tracking-tight text-gray-900">Sortie Equipements</h1>
    </div>
  </header>
  <main>
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
      {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="{{ label == 'success' ? 'success-message' : 'error-message' }} flash-message">{{ message }}</div>
        {% endfor %}
      {% endfor %}
      <div class="overflow-x-auto rounded-lg shadow mt-6">
        <h2 class="text-xl font-bold mb-4 text-green-700">Suivi des équipements en temps réel</h2>
        <div id="realtime-equipements" class="mb-8"></div>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom de L'equipement</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catégorie</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Disponibilité</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for equipement in equipements %}
            {% if equipement.etat == 'Disponible' %}
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" data-equipement-id="{{ equipement.id }}">
                <div class="flex items-center space-x-3">
                  <span>{{ equipement.nom }}</span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
    {{ equipement.etat == 'Disponible' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' }}">
                        {% if equipement.etat == 'Disponible' %}Disponible{% else %}Indisponible{% endif %}
</span>

                </div>
                <div class="sensor-details mt-1">
                  <!-- Les détails des capteurs seront mis à jour par JavaScript -->
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ equipement.capteurs|default('-') }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {% if equipement.etat == 'Pris'  %}
                  <form method="POST" action="{{ path('remise_equipement', {id: equipement.id}) }}">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Remettre</button>
                  </form>
                {% else %}
                  <span class="text-gray-500">Non pris</span>
                {% endif %}
              </td>
            </tr>
            {% endif %}
            {% else %}
            <tr>
              <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">Aucun équipement disponible.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <!-- Bouton pour ouvrir le modal global -->
      <div class="mt-4">
        <button class="inline-flex items-center gap-x-2 rounded-full border border-green-700 bg-green-600 px-5 py-2 text-sm font-semibold text-white shadow-md hover:bg-green-700 hover:border-green-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-700 transition-all duration-150" type="button" onclick="openGlobalModal()">
          <svg class="-ml-0.5 h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
          Prendre plusieurs équipements
        </button>
      </div>
      <!-- Modal global -->
      <div id="global-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
          <button type="button" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl" onclick="closeGlobalModal()">&times;</button>
          <h2 class="text-xl font-bold mb-4 text-center"><img class="w-12" src="{{ asset('logo/udbl-logo.svg') }}" />Sortie : Sélection d'équipements</h2>
          <form action="{{ path('reservation_index') }}" method="post" class="space-y-4">
            <input type="hidden" name="date_prise" value="{{ "now"|date('Y-m-d H:i:s') }}">
            <div class="max-h-60 overflow-y-auto">
              {% for equipement in equipements %}
                {% if equipement.etat == 'Disponible' and equipement.etat != 'Déclassé' %}
                  <div class="flex items-center justify-between p-2 border-b">
                    <div class="flex items-center space-x-3">
                      <input type="checkbox" name="equipement_ids[]" value="{{ equipement.id }}" id="equipement-{{ equipement.id }}" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                      <label for="equipement-{{ equipement.id }}" class="text-sm font-medium text-gray-900">{{ equipement.nom }}</label>
                    </div>
                    <span class="text-xs text-green-800">Disponible</span>
                  </div>
                {% endif %}
              {% else %}
                <div class="px-6 py-4 text-center text-sm text-gray-500">Aucun équipement disponible.</div>
              {% endfor %}
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
              <input type="text" name="nom" class="block w-full border border-gray-300 rounded px-3 py-2" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Post-nom</label>
              <input type="text" name="postnom" class="block w-full border border-gray-300 rounded px-3 py-2" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Prénom</label>
              <input type="text" name="prenom" class="block w-full border border-gray-300 rounded px-3 py-2" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Promotion</label>
              <select name="promotion" class="block w-full border border-gray-300 rounded px-3 py-2" required>
                <option value="">Sélectionner</option>
                <option value="L1">L1</option>
                <option value="L2">L2</option>
                <option value="L3">L3</option>
                <option value="L4">L4</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Filière</label>
              <input type="text" name="filiere" id="filiere-global" class="block w-full border border-gray-300 rounded px-3 py-2" readonly />
            </div>
            <script>
              document.querySelector('select[name="promotion"]').addEventListener('change', function() {
                const filiereInput = document.getElementById('filiere-global');
                if (this.value === 'L1' || this.value === 'L2') {
                  filiereInput.value = 'Science de base';
                  filiereInput.readOnly = true;
                } else {
                  filiereInput.value = '';
                  filiereInput.readOnly = false;
                }
              });
            </script>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Adresse email</label>
              <input type="email" name="email" class="block w-full border border-gray-300 rounded px-3 py-2" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Numéro de téléphone</label>
              <input type="tel" name="telephone" class="block w-full border border-gray-300 rounded px-3 py-2" required />
            </div>
            <div>
              <input type="hidden" name="date_prise" class="block w-full border border-gray-300 rounded px-3 py-2" value="{{ "now"|date('Y-m-d\TH:i') }}" required />
                <input type="hidden" name="equipement_id" class="block w-full border border-gray-300 rounded px-3 py-2" required />
            <button type="submit" class="inline-flex items-center gap-x-2 rounded-full border border-green-700 bg-green-600 px-5 py-2 text-sm font-semibold text-white shadow-md hover:bg-green-700 hover:border-green-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-700 transition-all duration-150">
              <svg class="-ml-0.5 h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
              Valider la prise
            </button>
          </form>
        </div>
      </div>
    </div>
  </main>
</div>
<script>
function openGlobalModal() {
    document.getElementById('global-modal').classList.remove('hidden');
}
function closeGlobalModal() {
    document.getElementById('global-modal').classList.add('hidden');
}
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    document.querySelectorAll('.flash-message').forEach(function(el) {
      el.style.opacity = '0';
      setTimeout(function() {
        el.remove();
      }, 500);
    });
  }, 3500);
});
// Fonction pour charger le suivi en temps réel
function loadRealtimeEquipements() {
  fetch('/api/equipements/realtime')
    .then(response => response.json())
    .then(data => {
      let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      data.forEach(eq => {
        html += `<div class=\"border rounded p-4 bg-white shadow\">
          <div class=\"font-bold text-lg text-gray-900\">${eq.nom}</div>
          <div class=\"mb-2 text-sm text-gray-600\">Etat : <span class=\"font-semibold\">${eq.etat}</span></div>
        </div>`;
      });
      html += '</div>';
      document.getElementById('realtime-equipements').innerHTML = html;
    });
}
loadRealtimeEquipements();
setInterval(loadRealtimeEquipements, 10000);
</script>
{% endblock %}
